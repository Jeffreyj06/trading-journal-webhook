<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - TradingView Webhook Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }
        .signal-card:hover {
            transform: translateY(-2px);
        }
        .signal-new {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .recording {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: recording-pulse 1s infinite;
        }
        @keyframes recording-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Trading Journal</h1>
                <p class="text-gray-400">TradingView Webhook Integration</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">User</div>
                <input type="text" id="userName" placeholder="Enter your name" 
                       class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-white"
                       value="Jeffrey">
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex space-x-4 mb-8">
            <button onclick="showTab('signals')" id="signalsTab" 
                    class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 transition">
                Live Signals
            </button>
            <button onclick="showTab('leaderboard')" id="leaderboardTab"
                    class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                Leaderboard
            </button>
            <button onclick="showTab('trades')" id="tradesTab"
                    class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                All Trades
            </button>
            <button onclick="showTab('manual')" id="manualTab"
                    class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                Manual Entry
            </button>
        </div>

        <!-- Signals Tab -->
        <div id="signalsContent" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Live TradingView Signals</h2>
                <div class="flex space-x-2">
                    <button onclick="refreshSignals()" 
                            class="px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm">
                        Refresh
                    </button>
                    <button onclick="testWebhook()" 
                            class="px-3 py-1 bg-yellow-600 rounded hover:bg-yellow-700 text-sm">
                        Test Signal
                    </button>
                </div>
            </div>
            
            <div id="signalsList" class="space-y-4">
                <!-- Signals will be loaded here -->
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboardContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">Response Time Competition</h2>
            <div id="leaderboardList">
                <!-- Leaderboard will be loaded here -->
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="tradesContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">All Trades</h2>
            <div id="tradesList">
                <!-- Trades will be loaded here -->
            </div>
        </div>

        <!-- Manual Entry Tab -->
        <div id="manualContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">Manual Trade Entry</h2>
            <form id="tradeForm" class="bg-gray-800 p-6 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Currency Pair</label>
                        <input type="text" id="tradePair" placeholder="e.g., EURUSD" 
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Direction</label>
                        <select id="tradeDirection" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="long">Long (Buy)</option>
                            <option value="short">Short (Sell)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Entry Price</label>
                        <input type="number" step="0.00001" id="entryPrice" 
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Stop Loss</label>
                        <input type="number" step="0.00001" id="stopLoss" 
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Take Profit</label>
                        <input type="number" step="0.00001" id="takeProfit" 
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Result</label>
                        <select id="tradeResult" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="pending">Pending</option>
                            <option value="win">Win</option>
                            <option value="loss">Loss</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Trading Reasoning</label>
                    <textarea id="tradeReasoning" rows="3" placeholder="Why did you take this trade?" 
                              class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></textarea>
                </div>

                <div class="mt-4 flex space-x-4">
                    <button type="button" onclick="startRecording()" id="recordBtn"
                            class="px-4 py-2 bg-red-600 rounded hover:bg-red-700 transition">
                        🎤 Record Voice Note
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 transition">
                        Save Trade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Create Trade Entry</h3>
                <button onclick="closeEntryModal()" class="text-gray-400 hover:text-white">✕</button>
            </div>
            
            <form id="entryForm" class="space-y-4">
                <input type="hidden" id="entrySignalId">
                
                <div>
                    <label class="block text-sm font-medium mb-2">Currency Pair</label>
                    <input type="text" id="entryPair" readonly 
                           class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-gray-300 cursor-not-allowed">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Direction</label>
                    <select id="entryDirection" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="long">Long (Buy)</option>
                        <option value="short">Short (Sell)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Entry Price</label>
                    <input type="number" step="0.00001" id="entryEntryPrice" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Stop Loss</label>
                    <input type="number" step="0.00001" id="entryStopLoss" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Take Profit</label>
                    <input type="number" step="0.00001" id="entryTakeProfit" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Trading Reasoning</label>
                    <textarea id="entryReasoning" rows="3" placeholder="Why did you take this trade?" 
                              class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></textarea>
                </div>

                <div class="flex space-x-2">
                    <button type="button" onclick="startRecording()" 
                            class="px-4 py-2 bg-red-600 rounded hover:bg-red-700 transition">
                        🎤 Voice Note
                    </button>
                    <button type="button" onclick="closeEntryModal()" 
                            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">
                        Save Trade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentSignalId = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            refreshSignals();
            loadLeaderboard();
            loadTrades();
            
            // Auto-refresh signals every 10 seconds
            setInterval(refreshSignals, 10000);
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('button[id$="Tab"]').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.remove('bg-gray-700');
            document.getElementById(tabName + 'Tab').classList.add('bg-blue-600');
        }

        // Load signals from API
        async function refreshSignals() {
            try {
                const response = await fetch('/api/signals');
                const signals = await response.json();
                displaySignals(signals);
            } catch (error) {
                console.error('Error loading signals:', error);
            }
        }

        // Display signals
        function displaySignals(signals) {
            const signalsList = document.getElementById('signalsList');
            
            if (signals.length === 0) {
                signalsList.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p>No signals received yet</p>
                        <p class="text-sm mt-2">Waiting for TradingView webhooks...</p>
                    </div>
                `;
                return;
            }

            signalsList.innerHTML = signals.map(signal => {
                const isNew = !signal.analyzed;
                const timeAgo = getTimeAgo(new Date(signal.received_at));
                const responseTime = signal.response_time_seconds ? 
                    `${signal.response_time_seconds.toFixed(1)}s` : 'Pending';

                return `
                    <div class="signal-card bg-gray-800 p-4 rounded-lg border-l-4 ${isNew ? 'border-green-500 signal-new' : 'border-gray-600'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg font-semibold">${signal.ticker}</span>
                                    <span class="px-2 py-1 rounded text-sm ${signal.action === 'buy' ? 'bg-green-600' : 'bg-red-600'}">
                                        ${signal.action.toUpperCase()}
                                    </span>
                                    ${isNew ? '<span class="px-2 py-1 bg-yellow-600 rounded text-xs">NEW</span>' : ''}
                                </div>
                                <div class="text-gray-400 text-sm mt-1">
                                    Price: ${signal.price} | ${timeAgo}
                                </div>
                                ${signal.analyzed ? `
                                    <div class="text-green-400 text-sm mt-1">
                                        ✓ Analyzed by ${signal.analyzed_by} in ${responseTime}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                ${!signal.analyzed ? `
                                    <button onclick="openTradingView('${signal.ticker}')" 
                                            class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 text-sm">
                                        Analyze
                                    </button>
                                    <button onclick="createEntry('${signal.id}', '${signal.ticker}', ${signal.price})" 
                                            class="px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm ml-1">
                                        Entry
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open TradingView app with specific pair
        function openTradingView(ticker) {
            // Format ticker for TradingView (remove any special characters)
            const cleanTicker = ticker.replace(/[^A-Z]/g, '');
            
            // Try to open TradingView mobile app first
            const mobileAppUrl = `tradingview://symbol/FX_IDC:${cleanTicker}`;
            const webUrl = `https://www.tradingview.com/chart/?symbol=FX_IDC:${cleanTicker}`;
            
            // Check if we're on mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Try to open mobile app
                window.location.href = mobileAppUrl;
                
                // Fallback to web after a short delay if app doesn't open
                setTimeout(() => {
                    window.open(webUrl, '_blank');
                }, 1000);
            } else {
                // Open web version on desktop
                window.open(webUrl, '_blank');
            }
        }

        // Create trade entry from signal
        function createEntry(signalId, ticker, price) {
            // Store signal data
            document.getElementById('entrySignalId').value = signalId;
            document.getElementById('entryPair').value = ticker;
            document.getElementById('entryEntryPrice').value = price;
            
            // Show entry modal
            document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('entryModal').classList.add('flex');
            
            // Focus on direction field
            document.getElementById('entryDirection').focus();
        }

        // Close entry modal
        function closeEntryModal() {
            document.getElementById('entryModal').classList.add('hidden');
            document.getElementById('entryModal').classList.remove('flex');
            
            // Clear form
            document.getElementById('entryForm').reset();
        }

        // Entry form submission
        document.getElementById('entryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                signal_id: document.getElementById('entrySignalId').value,
                pair: document.getElementById('entryPair').value,
                direction: document.getElementById('entryDirection').value,
                entry_price: document.getElementById('entryEntryPrice').value,
                stop_loss: document.getElementById('entryStopLoss').value,
                take_profit: document.getElementById('entryTakeProfit').value,
                reasoning: document.getElementById('entryReasoning').value,
                created_by: document.getElementById('userName').value || 'Anonymous'
            };

            try {
                await fetch('/api/trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                closeEntryModal();
                loadTrades();
                
                // Show success message
                alert('Trade entry saved successfully!');
            } catch (error) {
                console.error('Error saving trade entry:', error);
                alert('Error saving trade entry');
            }
        });

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const leaderboard = await response.json();
                displayLeaderboard(leaderboard);
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Display leaderboard
        function displayLeaderboard(leaderboard) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-400">No analysis data yet</p>';
                return;
            }

            leaderboardList.innerHTML = `
                <div class="bg-gray-800 rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">Rank</th>
                                <th class="px-4 py-3 text-left">Trader</th>
                                <th class="px-4 py-3 text-right">Avg Response</th>
                                <th class="px-4 py-3 text-right">Fastest</th>
                                <th class="px-4 py-3 text-right">Signals</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${leaderboard.map((user, index) => `
                                <tr class="border-t border-gray-600">
                                    <td class="px-4 py-3">
                                        <span class="text-lg">${index + 1}${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : ''}</span>
                                    </td>
                                    <td class="px-4 py-3 font-medium">${user.user}</td>
                                    <td class="px-4 py-3 text-right">${user.average_response_time.toFixed(1)}s</td>
                                    <td class="px-4 py-3 text-right text-green-400">${user.fastest_response.toFixed(1)}s</td>
                                    <td class="px-4 py-3 text-right">${user.total_signals}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Load trades
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades');
                const trades = await response.json();
                displayTrades(trades);
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        // Display trades
        function displayTrades(trades) {
            const tradesList = document.getElementById('tradesList');
            
            if (trades.length === 0) {
                tradesList.innerHTML = '<p class="text-gray-400">No trades recorded yet</p>';
                return;
            }

            tradesList.innerHTML = trades.map(trade => `
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold">${trade.pair}</span>
                                <span class="px-2 py-1 rounded text-sm ${trade.direction === 'long' ? 'bg-green-600' : 'bg-red-600'}">
                                    ${trade.direction.toUpperCase()}
                                </span>
                                <span class="px-2 py-1 rounded text-sm ${getResultColor(trade.result)}">
                                    ${trade.result.toUpperCase()}
                                </span>
                            </div>
                            <div class="text-gray-400 text-sm mt-1">
                                Entry: ${trade.entry_price} | By: ${trade.created_by}
                            </div>
                            ${trade.reasoning ? `<div class="text-gray-300 text-sm mt-2">${trade.reasoning}</div>` : ''}
                        </div>
                        <div class="text-right">
                            ${trade.pips ? `<div class="font-semibold ${trade.pips > 0 ? 'text-green-400' : 'text-red-400'}">${trade.pips > 0 ? '+' : ''}${trade.pips} pips</div>` : ''}
                            <div class="text-gray-400 text-xs">${getTimeAgo(new Date(trade.created_at))}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Test webhook
        async function testWebhook() {
            try {
                await fetch('/test-webhook', { method: 'POST' });
                setTimeout(refreshSignals, 1000);
            } catch (error) {
                console.error('Error testing webhook:', error);
            }
        }

        // Utility functions
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function getResultColor(result) {
            switch (result) {
                case 'win': return 'bg-green-600';
                case 'loss': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }

        // Voice recording (basic implementation)
        async function startRecording() {
            const recordBtn = document.getElementById('recordBtn');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.textContent = '🎤 Record Voice Note';
                recordBtn.classList.remove('recording');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    // Here you would typically upload the audio file
                    console.log('Audio recorded:', audioBlob);
                };

                mediaRecorder.start();
                recordBtn.textContent = '⏹️ Stop Recording';
                recordBtn.classList.add('recording');
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        // Manual trade form submission
        document.getElementById('tradeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                pair: document.getElementById('tradePair').value,
                direction: document.getElementById('tradeDirection').value,
                entry_price: document.getElementById('entryPrice').value,
                stop_loss: document.getElementById('stopLoss').value,
                take_profit: document.getElementById('takeProfit').value,
                result: document.getElementById('tradeResult').value,
                reasoning: document.getElementById('tradeReasoning').value,
                created_by: document.getElementById('userName').value || 'Anonymous'
            };

            try {
                await fetch('/api/trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                // Clear form
                document.getElementById('tradeForm').reset();
                
                // Refresh trades list
                loadTrades();
                
                alert('Trade saved successfully!');
            } catch (error) {
                console.error('Error saving trade:', error);
                alert('Error saving trade');
            }
        });
    </script>
</body>
</html>
